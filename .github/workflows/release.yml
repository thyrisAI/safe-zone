name: Product Release

on:
  workflow_dispatch:
    inputs:
      product:
        description: "Which product to release"
        required: true
        type: choice
        options:
          - thyris-sz
          - tszclient-go
          - tszclient-py
          - tsz-cli
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: "Optional release notes (if empty: thyris-sz uses auto-generated notes, SDKs use empty body)"
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # tags and history for diff & versioning

      - name: Setup Go
        if: ${{ github.event.inputs.product == 'thyris-sz' || github.event.inputs.product == 'tszclient-go' || github.event.inputs.product == 'tsz-cli' }}
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Python
        if: ${{ github.event.inputs.product == 'tszclient-py' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build deps (for tszclient-py)
        if: ${{ github.event.inputs.product == 'tszclient-py' }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine

      - name: Run product specific release script
        run: |
          chmod +x ci/release_${{ github.event.inputs.product }}.sh
          ci/release_${{ github.event.inputs.product }}.sh --bump ${{ github.event.inputs.bump }}

      # thyris-sz: create release (auto or manual notes depending on input) with a core artifact zip
      - name: Determine last thyris-sz tag
        if: ${{ github.event.inputs.product == 'thyris-sz' }}
        run: |
          LAST_TAG=$(git tag --list 'thyris-sz-v*' | sort -V | tail -n 1)
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV

      - name: Package thyris-sz artifact
        if: ${{ github.event.inputs.product == 'thyris-sz' }}
        run: |
          VERSION=${LAST_TAG#thyris-sz-v}
          ZIP_NAME="thyris-sz-${VERSION}.zip"
          echo "Packaging thyris-sz core into $ZIP_NAME"
          zip -r "$ZIP_NAME" internal .env.example Dockerfile LICENSE docker-compose.yml go.mod go.sum init.sql main.go -x '**/__pycache__/*' '*.pyc' '*.pyo'

      - name: Create GitHub Release for thyris-sz (manual notes)
        if: ${{ github.event.inputs.product == 'thyris-sz' && github.event.inputs.release_notes != '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: thyris-sz-*.zip
          body: ${{ github.event.inputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release for thyris-sz (auto-generated notes)
        if: ${{ github.event.inputs.product == 'thyris-sz' && github.event.inputs.release_notes == '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: thyris-sz-*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Go SDK: package only SDK + examples as a zip artifact (in addition to source code)
      - name: Package Go SDK artifact (tszclient-go)
        if: ${{ github.event.inputs.product == 'tszclient-go' }}
        run: |
          LAST_TAG=$(git tag --list 'tszclient-go-v*' | sort -V | tail -n 1)
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
          VERSION=${LAST_TAG#tszclient-go-v}
          ZIP_NAME="tszclient-go-${VERSION}.zip"
          echo "Packaging Go SDK from pkg/tszclient-go and examples/go-sdk-demo into $ZIP_NAME"
          zip -r "$ZIP_NAME" pkg/tszclient-go examples/go-sdk-demo -x '**/__pycache__/*' '*.pyc' '*.pyo'

      - name: Create GitHub Release for Go SDK (manual notes)
        if: ${{ github.event.inputs.product == 'tszclient-go' && github.event.inputs.release_notes != '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: tszclient-go-*.zip
          body: ${{ github.event.inputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release for Go SDK (no notes)
        if: ${{ github.event.inputs.product == 'tszclient-go' && github.event.inputs.release_notes == '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: tszclient-go-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Python SDK: package only SDK + examples as a zip artifact (in addition to source code)
      - name: Package Python SDK artifact (tszclient-py)
        if: ${{ github.event.inputs.product == 'tszclient-py' }}
        run: |
          LAST_TAG=$(git tag --list 'tszclient-py-v*' | sort -V | tail -n 1)
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
          VERSION=${LAST_TAG#tszclient-py-v}
          ZIP_NAME="tszclient-py-${VERSION}.zip"
          echo "Packaging Python SDK from pkg/tszclient_py and examples/python-sdk-demo into $ZIP_NAME"
          zip -r "$ZIP_NAME" pkg/tszclient_py examples/python-sdk-demo -x '**/__pycache__/*' '*.pyc' '*.pyo'

      - name: Create GitHub Release for Python SDK (manual notes)
        if: ${{ github.event.inputs.product == 'tszclient-py' && github.event.inputs.release_notes != '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: tszclient-py-*.zip
          body: ${{ github.event.inputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release for Python SDK (no notes)
        if: ${{ github.event.inputs.product == 'tszclient-py' && github.event.inputs.release_notes == '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: tszclient-py-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # TSZ CLI: package source + build binaries for release
      - name: Build and Package TSZ CLI
        if: ${{ github.event.inputs.product == 'tsz-cli' }}
        run: |
          LAST_TAG=$(git tag --list 'tsz-cli-v*' | sort -V | tail -n 1)
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
          VERSION=${LAST_TAG#tsz-cli-v}
          
          # 1. Source Archive
          ZIP_NAME="tsz-cli-${VERSION}-src.zip"
          echo "Packaging CLI source into $ZIP_NAME"
          zip -r "$ZIP_NAME" pkg/tsz-cli -x '**/__pycache__/*' '*.pyc' '*.pyo'
          
          # 2. Build Binaries
          cd pkg/tsz-cli
          
          # Windows
          echo "Building for Windows..."
          GOOS=windows GOARCH=amd64 go build -o ../../tsz-cli-windows-amd64.exe
          
          # Linux
          echo "Building for Linux..."
          GOOS=linux GOARCH=amd64 go build -o ../../tsz-cli-linux-amd64
          
          # macOS (Intel)
          echo "Building for macOS (Intel)..."
          GOOS=darwin GOARCH=amd64 go build -o ../../tsz-cli-darwin-amd64
          
          # macOS (Apple Silicon)
          echo "Building for macOS (ARM64)..."
          GOOS=darwin GOARCH=arm64 go build -o ../../tsz-cli-darwin-arm64
          
          cd ../..
          
      - name: Create GitHub Release for TSZ CLI (manual notes)
        if: ${{ github.event.inputs.product == 'tsz-cli' && github.event.inputs.release_notes != '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: |
            tsz-cli-*-src.zip
            tsz-cli-windows-amd64.exe
            tsz-cli-linux-amd64
            tsz-cli-darwin-amd64
            tsz-cli-darwin-arm64
          body: ${{ github.event.inputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release for TSZ CLI (no notes)
        if: ${{ github.event.inputs.product == 'tsz-cli' && github.event.inputs.release_notes == '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LAST_TAG }}
          files: |
            tsz-cli-*-src.zip
            tsz-cli-windows-amd64.exe
            tsz-cli-linux-amd64
            tsz-cli-darwin-amd64
            tsz-cli-darwin-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: TSZ CI

on:
  push:
    branches:
      - main
      - develop
      - feature/**
  pull_request:
    branches:
      - main
      - develop

jobs:
  unit-tests:
    name: Unit tests (fast)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache Go build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            GOPATH/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run unit tests
        run: go test -tags test ./tests/unit/...

  integration-tests:
    name: Integration tests (/detect, templates, gateway)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: thyris
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=10s --health-timeout=5s --health-retries=5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run TSZ server
        env:
          DB_DSN: postgres://postgres:postgres@localhost:5432/thyris?sslmode=disable&TimeZone=Europe/Istanbul
          REDIS_URL: redis://localhost:6379/0
          PII_MODE: MASK
        run: |
          go build -o tsz-gateway .
          ./tsz-gateway &
          echo "Waiting for server..." && sleep 15

      - name: Run integration tests
        env:
          TSZ_BASE_URL: http://localhost:8080
        run: go test ./tests/integration/...

  smoke-tests:
    name: Smoke / Sanity tests (e2e)
    runs-on: ubuntu-latest
    needs:
      - unit-tests
      - integration-tests
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: thyris
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=10s --health-timeout=5s --health-retries=5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run TSZ server
        env:
          DB_DSN: postgres://postgres:postgres@localhost:5432/thyris?sslmode=disable&TimeZone=Europe/Istanbul
          REDIS_URL: redis://localhost:6379/0
          PII_MODE: MASK
        run: |
          go build -o tsz-gateway .
          ./tsz-gateway &
          echo "Waiting for server..." && sleep 20

      - name: Run smoke and streaming tests
        env:
          TSZ_BASE_URL: http://localhost:8080
        run: go test ./tests/e2e/...
